{% extends "base.html" %}
{% load static %}
{% load media_tags %}

{% block title %}Dashboard | KBG Europe{% endblock %}

{% block content %}
<!-- Chart.js Bibliothek laden -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Modal f√ºr Bildvorschau -->
<div id="imageModal" class="image-modal" onclick="closeModal()">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImg">
    <div id="caption"></div>
</div>

<section class="section section-light" style="min-height: 80vh;">
    <div class="container">

        <!-- DASHBOARD HEADER -->
        <div class="dashboard-header">
            <div>
                <h1 class="section-title" style="margin-bottom: 0;">Dashboard</h1>
                <p style="color: #666;">Willkommen im internen Bereich.</p>
            </div>
            <div class="header-actions">
                <a class="btn" href="{% url 'home' %}" style="background: #fff; border: 1px solid #ddd; color: #333;">Zur√ºck zur Website</a>
                <form method="post" action="{% url 'logout' %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary">Abmelden</button>
                </form>
            </div>
        </div>

        <!-- LAYOUT CONTAINER -->
        <div class="dashboard-layout">

            <!-- HAUPT NAVIGATION (TABS) -->
            <nav class="dashboard-tabs" aria-label="Dashboard-Bereiche">
                <button type="button" class="dashboard-tab-btn" onclick="openTab('statistiken')">Statistiken</button>
                <button type="button" class="dashboard-tab-btn" onclick="openTab('anfragen')">Anfragen</button>
                <button type="button" class="dashboard-tab-btn" onclick="openTab('medien')">Medien</button>
                <button type="button" class="dashboard-tab-btn" onclick="openTab('karriere')">Karriere / Jobs</button>
                <button type="button" class="dashboard-tab-btn" onclick="openTab('seo')">SEO</button>
                {% if user.is_superuser %}
                <button type="button" class="dashboard-tab-btn" onclick="openTab('benutzer')">Benutzer-Management</button>
                {% endif %}
            </nav>

            <!-- PANELS -->
            <div class="dashboard-panels">

                <!-- 1. STATISTIKEN (Altes Design wiederhergestellt) -->
                <div id="statistiken" class="dashboard-panel">
                    <div class="stats-header mb-4">
                        <h2>Website Performance</h2>
                        <p style="color:#777; font-size:0.9rem;">Daten der letzten 30 Tage</p>
                    </div>

                    <!-- Key Metrics (Grid Layout) -->
                    <div class="stats-grid-top">
                        <div class="stat-card">
                            <div class="stat-icon" style="background:#e0f2f1; color:#007755;">üë•</div>
                            <div class="stat-info">
                                <h3>{{ stats.total_visits|default:"0" }}</h3>
                                <p>Seitenaufrufe</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background:#e8f5e9; color:#2e7d32;">üñ±Ô∏è</div>
                            <div class="stat-info">
                                <h3>{{ stats.unique_visitors|default:"0" }}</h3>
                                <p>Eindeutige Besucher</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background:#fff3e0; color:#f57c00;">üìÖ</div>
                            <div class="stat-info">
                                <h3>{{ stats.today_visits|default:"0" }}</h3>
                                <p>Aufrufe Heute</p>
                            </div>
                        </div>
                    </div>

                    <!-- Diagramm & Tabelle -->
                    <div class="stats-grid-bottom mt-4">

                        <!-- Diagramm -->
                        <div class="card p-4 shadow-sm" style="grid-column: span 2;">
                            <h4 style="margin-bottom: 1rem; margin-top: 0;">Besucher-Trend (30 Tage)</h4>
                            <div style="position: relative; height: 300px; width: 100%;">
                                <canvas id="trafficChart"></canvas>
                            </div>
                        </div>

                        <!-- Tabelle -->
                        <div class="card p-4 shadow-sm" style="grid-column: span 2;">
                            <h4 style="margin-top: 0;">Beliebteste Seiten</h4>
                            <table class="simple-table mt-3">
                                <thead>
                                    <tr><th>Seite (Pfad)</th><th>Aufrufe</th></tr>
                                </thead>
                                <tbody>
                                    {% if stats.top_pages %}
                                        {% for page in stats.top_pages %}
                                        <tr><td>{{ page.path }}</td><td><strong>{{ page.count }}</strong></td></tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr><td colspan="2">Noch keine Daten verf√ºgbar.</td></tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 2. ANFRAGEN -->
                <div id="anfragen" class="dashboard-panel">
                    <h2>Anfragen Verwaltung</h2>
                    <!-- (Hier deine Anfragen-Tabellen, Code gek√ºrzt da unver√§ndert) -->
                    <div class="table-section">
                        <h3>Catering-Anfragen</h3>
                        <div class="table-responsive shadow-sm">
                            <table class="modern-table">
                                <thead><tr><th>Datum</th><th>Name</th><th>E-Mail</th><th>Status</th><th style="text-align: right;">Aktion</th></tr></thead>
                                <tbody>
                                    {% for req in catering_requests %}
                                    <tr>
                                        <td>{{ req.created_at|date:"d.m.Y" }}<br><small style="color:#888;">{{ req.created_at|date:"H:i" }} Uhr</small></td>
                                        <td><strong>{{ req.contact_person }}</strong></td>
                                        <td><a href="mailto:{{ req.email }}">{{ req.email }}</a></td>
                                        <td>{% if req.status == "open" %}<span class="badge badge-open">Offen</span>{% else %}<span class="badge badge-done">Beantwortet</span>{% endif %}</td>
                                        <td style="text-align: right;"><button type="button" class="btn-icon" onclick="toggleReply('catering-{{ req.id }}')">‚Ü© Antworten</button></td>
                                    </tr>
                                    <tr id="reply-row-catering-{{ req.id }}" class="reply-row" style="display:none;">
                                        <td colspan="5">
                                            <div class="reply-box">
                                                <form method="post" action="{% url 'answer_catering_request' req.id %}">
                                                    {% csrf_token %}
                                                    <label>Antwort an {{ req.email }}:</label>
                                                    <textarea name="reply_text" class="form-control reply-textarea">{% if req.reply_text %}{{ req.reply_text }}{% endif %}</textarea>
                                                    <div style="margin-top:.5rem; text-align: right;"><button type="submit" class="btn btn-primary btn-sm">Senden & Abschlie√üen</button></div>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="5" style="text-align:center; padding: 2rem;">Keine Catering-Anfragen.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="table-section mt-5">
                        <h3>Kontakt-Anfragen</h3>
                        <!-- ... Kontakt Tabelle ... -->
                         <div class="table-responsive shadow-sm">
                            <table class="modern-table">
                                <thead><tr><th>Datum</th><th>Name</th><th>Nachricht</th><th>Status</th><th style="text-align: right;">Aktion</th></tr></thead>
                                <tbody>
                                    {% for req in contact_requests %}
                                    <tr>
                                        <td>{{ req.created_at|date:"d.m.Y" }}<br><small style="color:#888;">{{ req.created_at|date:"H:i" }} Uhr</small></td>
                                        <td>{{ req.name }}<br><small>{{ req.email }}</small></td>
                                        <td><div style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ req.message }}</div></td>
                                        <td>{% if req.status == "open" %}<span class="badge badge-open">Offen</span>{% else %}<span class="badge badge-done">Beantwortet</span>{% endif %}</td>
                                        <td style="text-align: right;"><button type="button" class="btn-icon" onclick="toggleReply('contact-{{ req.id }}')">‚Ü© Antworten</button></td>
                                    </tr>
                                    <tr id="reply-row-contact-{{ req.id }}" class="reply-row" style="display:none;">
                                        <td colspan="5">
                                            <div class="reply-box">
                                                <form method="post" action="{% url 'answer_contact_request' req.id %}">
                                                    {% csrf_token %}
                                                    <label>Antwort an {{ req.email }}:</label>
                                                    <textarea name="reply_text" class="form-control reply-textarea">{% if req.reply_text %}{{ req.reply_text }}{% endif %}</textarea>
                                                    <div style="margin-top:.5rem; text-align: right;"><button type="submit" class="btn btn-primary btn-sm">Senden & Abschlie√üen</button></div>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="5" style="text-align:center; padding: 2rem;">Keine Kontakt-Anfragen.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. MEDIEN -->
                <div id="medien" class="dashboard-panel">
                    <!-- Header mit Save Button rechts -->
                    <div class="media-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
                        <h2 style="margin:0;">Medien & Inhalte Verwaltung</h2>
                        <button type="button" class="btn btn-primary" onclick="saveAllMedia()">
                            üíæ Alle √Ñnderungen speichern
                        </button>
                    </div>

                    <!-- Medien Sub-Navigation -->
                    <nav class="media-subtabs">
                        <button type="button" class="media-subtab-btn active" onclick="openMediaSubTab('media-home')">Home</button>
                        <button type="button" class="media-subtab-btn" onclick="openMediaSubTab('media-menu')">Men√º</button>
                        <button type="button" class="media-subtab-btn" onclick="openMediaSubTab('media-catering')">Catering</button>
                        <button type="button" class="media-subtab-btn" onclick="openMediaSubTab('media-kontakt')">Kontakt</button>
                        <button type="button" class="media-subtab-btn" onclick="openMediaSubTab('media-order')">Bestellen</button>
                        <button type="button" class="media-subtab-btn" onclick="openMediaSubTab('media-layout')">Layout / Footer</button>
                    </nav>

                    <!-- HOME SUB-TAB -->
                    <div id="media-home" class="media-subpanel active">
                        <h3>Startseite</h3>
                        {% include "admin_dashboard/includes/media_row.html" with key="home_hero" label="Hero Bild" desc="Gro√ües Bild ganz oben." img_obj=site_images.home_hero %}
                        <!-- ... restliche Home Items ... -->
                        {% include "admin_dashboard/includes/media_row.html" with key="home_about_image" label="Wer wir sind (Slider 1)" desc="Slider Bild 1." img_obj=site_images.home_about_image %}
                        {% include "admin_dashboard/includes/media_row.html" with key="home_about_image_2" label="Wer wir sind (Slider 2)" desc="Slider Bild 2." img_obj=site_images.home_about_image_2 %}
                        <hr style="margin: 1.5rem 0;">
                        {% include "admin_dashboard/includes/media_row.html" with key="home_menu_1" label="Men√º Links" desc="Bild links (25%)." img_obj=site_images.home_menu_1 %}
                        {% include "admin_dashboard/includes/media_row.html" with key="home_menu_2" label="Men√º Rechts" desc="Bild rechts (25%)." img_obj=site_images.home_menu_2 %}
                        <h4 class="mt-4">Catering Galerie</h4>
                        {% include "admin_dashboard/includes/media_row.html" with key="home_catering_1" label="Catering 1" desc="Spalte 1" img_obj=site_images.home_catering_1 %}
                        {% include "admin_dashboard/includes/media_row.html" with key="home_catering_2" label="Catering 2" desc="Spalte 2" img_obj=site_images.home_catering_2 %}
                        {% include "admin_dashboard/includes/media_row.html" with key="home_catering_3" label="Catering 3" desc="Spalte 3" img_obj=site_images.home_catering_3 %}
                        {% include "admin_dashboard/includes/media_row.html" with key="home_catering_4" label="Catering 4" desc="Spalte 4" img_obj=site_images.home_catering_4 %}
                        <h4 class="mt-4">Kundenstimmen</h4>
                        {% include "admin_dashboard/includes/media_row.html" with key="home_testimonials_bg" label="Hintergrund" desc="Hinter dem Slider." img_obj=site_images.home_testimonials_bg %}
                    </div>

                    <!-- MENU SUB-TAB -->
                    <div id="media-menu" class="media-subpanel">
                        <!-- ... Menu Code ... -->
                         <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <div>
                                <h3>Men√º Seite verwalten</h3>
                                <p style="color:#666; margin:0;">Bearbeite Bilder, Texte und Hintergr√ºnde der Men√º-Bl√∂cke.</p>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('new-menu-item-form').style.display='block';">
                                + Neuer Men√º-Block
                            </button>
                        </div>
                        <div style="background:#f9f9f9; padding:1rem; border-radius:8px; margin-bottom:2rem; border:1px solid #eee;">
                            <h4 style="margin-top:0;">Header Bild</h4>
                            {% include "admin_dashboard/includes/media_row.html" with key="menu_hero" label="Menu Hero" desc="Hintergrundbild Header." img_obj=site_images.menu_hero %}
                        </div>
                        <hr>
                        <div id="menu-items-list">
                            {% for item in menu_items %}
                            <!-- Menu Items Loop (unver√§ndert) -->
                            <div class="card" style="padding: 1.5rem; margin-bottom: 2rem; border: 1px solid #ddd; position: relative;">
                                <form method="post" action="{% url 'dashboard_menu_item_delete' item.id %}" onsubmit="return confirm('Block wirklich l√∂schen?');" style="position: absolute; top: 1rem; right: 1rem;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn-icon delete" title="L√∂schen">üóë</button>
                                </form>
                                <h4 style="margin-top:0; color:var(--kbg-green);">Block {{ forloop.counter }}: {{ item.name }}</h4>
                                <form method="post" enctype="multipart/form-data" action="{% url 'dashboard_menu_item_update' item.id %}" class="media-upload-form">
                                    {% csrf_token %}
                                    <div style="display: grid; grid-template-columns: 100px 1fr 1fr; gap: 1.5rem; align-items: start;">
                                        <!-- Bild -->
                                        <div style="text-align: center;">
                                            {% if item.image %}
                                                <img src="{{ item.image.url }}" onclick="openModal(this.src)" style="width:100px; height:100px; object-fit:cover; border-radius:6px; cursor:pointer; border:1px solid #ccc;">
                                            {% else %}
                                                <div style="width:100px; height:100px; background:#eee; border-radius:6px; display:flex; align-items:center; justify-content:center;">Kein Bild</div>
                                            {% endif %}
                                            <input type="file" name="image" style="font-size:0.75rem; margin-top:0.5rem; width:100%;">
                                        </div>
                                        <!-- Texte -->
                                        <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                                            <input type="text" name="dish_id" class="form-control" value="{{ item.dish_id }}" placeholder="Nummer (z.B. 1)">
                                            <input type="text" name="name" class="form-control" value="{{ item.name }}" placeholder="Name" style="font-weight:bold;">
                                            <input type="text" name="subtitle" class="form-control" value="{{ item.subtitle }}" placeholder="Untertitel">
                                            <textarea name="description_de" class="form-control" rows="2" placeholder="Beschreibung DE">{{ item.description_de }}</textarea>
                                            <textarea name="description_en" class="form-control" rows="2" placeholder="Beschreibung EN">{{ item.description_en }}</textarea>
                                        </div>
                                        <!-- Design & Optionen -->
                                        <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                                            <textarea name="options_text" class="form-control" rows="5" placeholder="Optionen (z.B. 1A Bulgogi)">{{ item.options_text }}</textarea>
                                            <div style="background:#f5f5f5; padding:0.8rem; border-radius:6px;">
                                                <label style="font-size:0.8rem; font-weight:bold;">Hintergrund</label>
                                                <div style="display:flex; gap:0.5rem; margin-top:0.5rem;">
                                                    <input type="color" value="{{ item.background_color }}" onchange="this.nextElementSibling.value = this.value" style="height:35px; width:40px; padding:0; border:none;">
                                                    <input type="text" name="background_color" class="form-control" value="{{ item.background_color }}" style="margin:0;">
                                                </div>
                                                <div style="margin-top:0.8rem;">
                                                    <input type="file" name="background_image" style="font-size:0.75rem;">
                                                    {% if item.background_image %}
                                                    <label style="font-size:0.75rem; display:block; margin-top:4px;"><input type="checkbox" name="delete_bg_image"> Bild entfernen</label>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <input type="number" name="order" class="form-control" value="{{ item.order }}" placeholder="Reihenfolge">
                                        </div>
                                    </div>
                                </form>
                            </div>
                            {% endfor %}
                        </div>
                        <div id="new-menu-item-form" style="display:none; margin-top:3rem; border:2px dashed #ccc; padding:2rem; border-radius:8px; background:#fff;">
                            <h3 style="margin-top:0;">Neuen Men√º-Block hinzuf√ºgen</h3>
                            <form method="post" enctype="multipart/form-data" action="{% url 'dashboard_menu_item_create' %}">
                                {% csrf_token %}
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                    <div>
                                        <label>Bild *</label>
                                        <input type="file" name="image" class="form-control" required>
                                        <input type="text" name="dish_id" class="form-control" placeholder="Nummer (z.B. 10)" style="margin-top:1rem;">
                                        <input type="text" name="name" class="form-control" required placeholder="Gericht Name" style="margin-top:1rem;">
                                    </div>
                                    <div>
                                        <label>Hintergrundfarbe</label>
                                        <input type="text" name="background_color" class="form-control" value="#ffffff">
                                        <label style="margin-top:1rem;">Beschreibung (DE)</label>
                                        <textarea name="description_de" class="form-control" rows="3"></textarea>
                                    </div>
                                </div>
                                <div style="margin-top:1.5rem; text-align:right;">
                                    <button type="button" class="btn" onclick="document.getElementById('new-menu-item-form').style.display='none'">Abbrechen</button>
                                    <button type="submit" class="btn btn-primary">Erstellen</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- CATERING SUB-TAB -->
                    <div id="media-catering" class="media-subpanel">
                        <h3>Catering Seite</h3>
                        {% include "admin_dashboard/includes/media_row.html" with key="catering_hero" label="Catering Hero" desc="Bild oben." img_obj=site_images.catering_hero %}
                        {% include "admin_dashboard/includes/media_row.html" with key="catering_bottom" label="Catering Unten" desc="Dekobild unten." img_obj=site_images.catering_bottom %}
                    </div>

                    <!-- KONTAKT SUB-TAB -->
                    <div id="media-kontakt" class="media-subpanel">
                        <h3>Kontakt Seite</h3>
                        {% include "admin_dashboard/includes/media_row.html" with key="contact_top_bg" label="Top Banner (√úber uns)" desc="Hintergrundbild ganz oben." img_obj=site_images.contact_top_bg %}
                        <hr style="margin: 1.5rem 0;">
                        {% include "admin_dashboard/includes/media_row.html" with key="contact_philosophie_img" label="Bild: Philosophie" desc="Bild links neben 'So isst man zusammen'." img_obj=site_images.contact_philosophie_img %}
                        <hr style="margin: 1.5rem 0;">
                        {% include "admin_dashboard/includes/media_row.html" with key="contact_mission_img" label="Bild: Mission" desc="Bild rechts neben 'Harmonie aus der Natur'." img_obj=site_images.contact_mission_img %}
                        <hr style="margin: 1.5rem 0;">
                        {% include "admin_dashboard/includes/media_row.html" with key="contact_bottom_bg" label="Hintergrund Kontaktformular" desc="Bild hinter dem Formular unten." img_obj=site_images.contact_bottom_bg %}
                    </div>

                    <!-- ORDER SUB-TAB -->
                    <div id="media-order" class="media-subpanel">
                        <h3>Seite: Bestellen & Abholen</h3>
                        {% include "admin_dashboard/includes/media_row.html" with key="order_hero" label="Hintergrundbild" desc="Das gro√üe Bild im Hintergrund." img_obj=site_images.order_hero %}
                        <hr style="border: 0; border-top: 1px solid #eee; margin: 2rem 0;">
                        <h3>Buttons verwalten</h3>
                        <!-- Form code wie gehabt -->
                        <form method="post" action="{% url 'dashboard_settings_update' %}" class="media-upload-form">
                            {% csrf_token %}
                            <input type="hidden" name="address" value="{{ site_settings.address }}">
                            <input type="hidden" name="opening_hours" value="{{ site_settings.opening_hours }}">
                            <input type="hidden" name="phone" value="{{ site_settings.phone }}">
                            <input type="hidden" name="email" value="{{ site_settings.email }}">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                <div class="card p-3" style="background: #fdfdfd; border: 1px solid #eee;">
                                    <h5 style="color: var(--kbg-green); margin-top:0;">Abholen</h5>
                                    <input type="text" name="btn_pickup_text" class="form-control" value="{{ site_settings.btn_pickup_text }}" placeholder="Text">
                                    <input type="text" name="btn_pickup_link" class="form-control" value="{{ site_settings.btn_pickup_link }}" placeholder="Link">
                                </div>
                                <div class="card p-3" style="background: #fdfdfd; border: 1px solid #eee;">
                                    <h5 style="color: #3f7dbb; margin-top:0;">Wolt</h5>
                                    <input type="text" name="btn_wolt_text" class="form-control" value="{{ site_settings.btn_wolt_text }}" placeholder="Text">
                                    <input type="text" name="btn_wolt_link" class="form-control" value="{{ site_settings.btn_wolt_link }}" placeholder="Link">
                                </div>
                                <div class="card p-3" style="background: #fdfdfd; border: 1px solid #eee;">
                                    <h5 style="color: #c88a27; margin-top:0;">Lieferando</h5>
                                    <input type="text" name="btn_lieferando_text" class="form-control" value="{{ site_settings.btn_lieferando_text }}" placeholder="Text">
                                    <input type="text" name="btn_lieferando_link" class="form-control" value="{{ site_settings.btn_lieferando_link }}" placeholder="Link">
                                </div>
                                <div class="card p-3" style="background: #fdfdfd; border: 1px solid #eee;">
                                    <h5 style="color: #2e6a57; margin-top:0;">Uber Eats</h5>
                                    <input type="text" name="btn_uber_text" class="form-control" value="{{ site_settings.btn_uber_text }}" placeholder="Text">
                                    <input type="text" name="btn_uber_link" class="form-control" value="{{ site_settings.btn_uber_link }}" placeholder="Link">
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- LAYOUT SUB-TAB -->
                    <div id="media-layout" class="media-subpanel">
                        <h3>Layout & Logos</h3>
                        {% include "admin_dashboard/includes/media_row.html" with key="global_logo" label="Logo Header" desc="Hauptlogo." img_obj=site_images.global_logo %}
                        {% include "admin_dashboard/includes/media_row.html" with key="instagram_icon" label="Instagram Icon" desc="F√ºr Footer & Tabs." img_obj=site_images.instagram_icon %}
                        {% include "admin_dashboard/includes/media_row.html" with key="email_icon" label="Email Icon" desc="F√ºr Footer & Tabs." img_obj=site_images.email_icon %}
                        <hr style="border: 0; border-top: 1px solid #eee; margin: 2.5rem 0;">
                        <h3>Footer Informationen</h3>
                        <form method="post" action="{% url 'dashboard_settings_update' %}" class="media-upload-form">
                            {% csrf_token %}
                            <!-- Hidden Inputs -->
                            <input type="hidden" name="btn_pickup_text" value="{{ site_settings.btn_pickup_text }}">
                            <input type="hidden" name="btn_pickup_link" value="{{ site_settings.btn_pickup_link }}">
                            <input type="hidden" name="btn_wolt_text" value="{{ site_settings.btn_wolt_text }}">
                            <input type="hidden" name="btn_wolt_link" value="{{ site_settings.btn_wolt_link }}">
                            <input type="hidden" name="btn_lieferando_text" value="{{ site_settings.btn_lieferando_text }}">
                            <input type="hidden" name="btn_lieferando_link" value="{{ site_settings.btn_lieferando_link }}">
                            <input type="hidden" name="btn_uber_text" value="{{ site_settings.btn_uber_text }}">
                            <input type="hidden" name="btn_uber_link" value="{{ site_settings.btn_uber_link }}">
                            <div class="card" style="padding: 2rem; background:#ffffff; border: 1px solid #eee; border-radius: 8px;">
                                <div class="form-group mb-3">
                                    <label style="font-weight:600; color:#444;">Adresse</label>
                                    <input type="text" name="address" class="form-control" value="{{ site_settings.address }}">
                                </div>
                                <div class="form-group mb-3">
                                    <label style="font-weight:600; color:#444;">√ñffnungszeiten</label>
                                    <input type="text" name="opening_hours" class="form-control" value="{{ site_settings.opening_hours }}">
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                                    <div class="form-group mb-3">
                                        <label style="font-weight:600; color:#444;">Telefonnummer</label>
                                        <input type="text" name="phone" class="form-control" value="{{ site_settings.phone }}">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label style="font-weight:600; color:#444;">E-Mail Adresse</label>
                                        <input type="email" name="email" class="form-control" value="{{ site_settings.email }}">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 4. KARRIERE / JOBS (Haupt-Tab) -->
                <div id="karriere" class="dashboard-panel">

                    <!-- Header mit Save Button -->
                    <div class="media-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                        <h2>Karriere / Jobs Management</h2>
                        <!-- Der Button speichert Job Inhalte UND Franchise Slider -->
                        <div class="save-btn-container" style="display:none;" id="save-jobs-btn">
                            <button type="button" class="btn btn-primary" onclick="saveAllMedia()">
                                üíæ Alle √Ñnderungen speichern
                            </button>
                        </div>
                    </div>

                    <!-- Sub-Navigation -->
                    <nav class="media-subtabs" style="margin-top: 0;">
                        <button type="button" class="media-subtab-btn active" onclick="openJobSubTab('job-apps')">Bewerbungen</button>
                        <button type="button" class="media-subtab-btn" onclick="openJobSubTab('job-content')">Inhalte & Slider</button>
                    </nav>

                    <!-- A) Bewerbungen -->
                    <div id="job-apps" class="job-subpanel active">
                        <h3>Eingegangene Bewerbungen</h3>
                        <div class="table-responsive shadow-sm">
                            <table class="modern-table">
                                <thead><tr><th>Datum</th><th>Name</th><th>Stelle</th><th>Dateien</th><th>Status / Kontakt</th></tr></thead>
                                <tbody>
                                    {% for app in applications %}
                                    <tr style="{% if app.status == 'new' %}background-color:#f0fdf4;{% endif %}">
                                        <td>{{ app.created_at|date:"d.m.Y H:i" }}</td>
                                        <td>{{ app.first_name }} {{ app.last_name }}</td>
                                        <td><span class="badge" style="background:#eee; color:#333;">{{ app.job_type }}</span></td>
                                        <td>
                                            {% if app.cover_letter %}<a href="{{ app.cover_letter.url }}" target="_blank">üìÑ Anschreiben</a><br>{% endif %}
                                            {% if app.cv %}<a href="{{ app.cv.url }}" target="_blank">üìÑ Lebenslauf</a>{% endif %}
                                        </td>
                                        <td>
                                            <a href="mailto:{{ app.email }}?subject=Bewerbung bei KBG&body=Hallo {{ app.first_name }}," class="btn btn-primary btn-sm" onclick="markProcessed({{ app.id }})" target="_blank">‚úâÔ∏è Antworten</a>
                                            <div style="margin-top:5px; font-size:0.8rem;">Status: <span id="status-text-{{ app.id }}" style="font-weight:bold; color:{% if app.status == 'new' %}#c0392b{% else %}#27ae60{% endif %};">{% if app.status == 'new' %}Unbearbeitet{% else %}Bearbeitet{% endif %}</span></div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="5" style="text-align:center; padding:2rem;">Keine Bewerbungen vorhanden.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- B) Inhalte (Jobs + Franchise) -->
                    <div id="job-content" class="job-subpanel">
                        <h3>Inhalte der 3 Job-Karten</h3>
                        <form method="post" enctype="multipart/form-data" action="{% url 'dashboard_job_content_update' %}" class="media-upload-form">
                            {% csrf_token %}

                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1.5rem; margin-bottom: 3rem;">
                                <!-- MANAGER -->
                                <div class="card p-3 shadow-sm">
                                    <h4 style="color:var(--kbg-green);">Shopleiter</h4>
                                    <label>Bild</label>
                                    {% if job_contents.manager.image %}<img src="{{ job_contents.manager.image.url }}" style="height:120px; width:100%; object-fit:cover; display:block; margin-bottom:5px; border-radius:6px;">{% endif %}
                                    <input type="file" name="manager_image" class="form-control">
                                    <label style="margin-top:1rem;">Listenpunkte</label>
                                    <textarea name="manager_short_desc" class="form-control" rows="4">{{ job_contents.manager.short_description }}</textarea>
                                    <hr>
                                    <label>Popup Titel</label>
                                    <input type="text" name="manager_popup_title" class="form-control" value="{{ job_contents.manager.popup_title }}">
                                    <label>Popup Text</label>
                                    <textarea name="manager_popup_text" class="form-control" rows="8">{{ job_contents.manager.popup_text }}</textarea>
                                </div>
                                <!-- SERVICE -->
                                <div class="card p-3 shadow-sm">
                                    <h4 style="color:var(--kbg-green);">Service</h4>
                                    <label>Bild</label>
                                    {% if job_contents.service.image %}<img src="{{ job_contents.service.image.url }}" style="height:120px; width:100%; object-fit:cover; display:block; margin-bottom:5px; border-radius:6px;">{% endif %}
                                    <input type="file" name="service_image" class="form-control">
                                    <label style="margin-top:1rem;">Listenpunkte</label>
                                    <textarea name="service_short_desc" class="form-control" rows="4">{{ job_contents.service.short_description }}</textarea>
                                    <hr>
                                    <label>Popup Titel</label>
                                    <input type="text" name="service_popup_title" class="form-control" value="{{ job_contents.service.popup_title }}">
                                    <label>Popup Text</label>
                                    <textarea name="service_popup_text" class="form-control" rows="8">{{ job_contents.service.popup_text }}</textarea>
                                </div>
                                <!-- COOK -->
                                <div class="card p-3 shadow-sm">
                                    <h4 style="color:var(--kbg-green);">Koch</h4>
                                    <label>Bild</label>
                                    {% if job_contents.cook.image %}<img src="{{ job_contents.cook.image.url }}" style="height:120px; width:100%; object-fit:cover; display:block; margin-bottom:5px; border-radius:6px;">{% endif %}
                                    <input type="file" name="cook_image" class="form-control">
                                    <label style="margin-top:1rem;">Listenpunkte</label>
                                    <textarea name="cook_short_desc" class="form-control" rows="4">{{ job_contents.cook.short_description }}</textarea>
                                    <hr>
                                    <label>Popup Titel</label>
                                    <input type="text" name="cook_popup_title" class="form-control" value="{{ job_contents.cook.popup_title }}">
                                    <label>Popup Text</label>
                                    <textarea name="cook_popup_text" class="form-control" rows="8">{{ job_contents.cook.popup_text }}</textarea>
                                </div>
                            </div>
                        </form>

                        <hr>

                        <!-- Franchise Slider -->
                        <div class="card p-4 shadow-sm" style="margin-top: 2rem;">
                            <h3 style="margin-top:0;">Franchise Slider</h3>
                            {% include "admin_dashboard/includes/media_row.html" with key="career_franchise_1" label="Slider Bild 1" desc="." img_obj=site_images.career_franchise_1 %}
                            <hr>
                            {% include "admin_dashboard/includes/media_row.html" with key="career_franchise_2" label="Slider Bild 2" desc="." img_obj=site_images.career_franchise_2 %}
                        </div>
                    </div>
                </div>

                <!-- 5. SEO -->
                <div id="seo" class="dashboard-panel">
                    <h2>SEO Einstellungen</h2>
                    <form method="post" action="">
                        {% csrf_token %}
                        <div class="form-group mb-3">
                            <label>Meta-Titel</label>
                            <input type="text" name="meta_title" class="form-control" placeholder="Website Titel...">
                        </div>
                        <div class="form-group mb-3">
                            <label>Meta-Beschreibung</label>
                            <textarea name="meta_description" class="form-control" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Speichern</button>
                    </form>
                </div>

                <!-- 6. BENUTZER MANAGEMENT -->
                {% if user.is_superuser %}
                <div id="benutzer" class="dashboard-panel">
                    <h2>Benutzer Management</h2>
                    <div class="user-layout">
                        <!-- Tabelle -->
                        <div class="user-list">
                            <h3>Registrierte Benutzer</h3>
                            <table class="modern-table shadow-sm">
                                <thead><tr><th>Name</th><th>E-Mail</th><th>Rolle</th><th></th></tr></thead>
                                <tbody>
                                    {% for u in users %}
                                    <tr>
                                        <td>{{ u.username }}</td><td>{{ u.email }}</td>
                                        <td>{% if u.is_superuser %}<span class="badge badge-admin">Admin</span>{% else %}<span class="badge badge-user">User</span>{% endif %}</td>
                                        <td style="text-align:right;">
                                            {% if u != user %}
                                            <form method="post" action="{% url 'dashboard_delete_user' u.id %}" onsubmit="return confirm('L√∂schen?');">
                                                {% csrf_token %}
                                                <button type="submit" class="btn-icon delete big-delete">üóë</button>
                                            </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <!-- Erstellen -->
                        <div class="user-create">
                            <div class="card p-4 shadow-sm">
                                <h3>Neuen Benutzer</h3>
                                <form method="post" action="{% url 'dashboard_create_user' %}">
                                    {% csrf_token %}
                                    <div class="form-group mb-3">
                                        <label>Benutzername</label>
                                        <input type="text" name="new_username" class="form-control" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label>E-Mail</label>
                                        <input type="email" name="new_email" class="form-control" required>
                                    </div>
                                    <div class="form-group mb-4">
                                        <label>Rolle</label>
                                        <select name="new_role" class="form-control">
                                            <option value="common">User</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary" style="width:100%;">Erstellen</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

            </div>
        </div>

    </div>
</section>

<div id="toast" class="toast">Gespeichert!</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // Tabs Restore
    const lastTab = localStorage.getItem("activeDashboardTab") || "statistiken";
    openTab(lastTab);
    const lastMediaTab = localStorage.getItem("activeMediaTab") || "media-home";
    openMediaSubTab(lastMediaTab);

    // Change Detection for AJAX Save
    document.querySelectorAll('.media-upload-form input, .media-upload-form textarea').forEach(input => {
        if(input.type !== 'file' && input.type !== 'hidden') input.setAttribute('data-original', input.value);
    });

    // Chart.js
    const ctx = document.getElementById('trafficChart');
    const chartLabels = {{ stats.chart_labels|default:"[]"|safe }};
    const chartData = {{ stats.chart_data|default:"[]"|safe }};

    if(ctx && chartLabels.length > 0) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Seitenaufrufe', data: chartData, borderColor: '#007755', backgroundColor: 'rgba(0, 119, 85, 0.1)', borderWidth: 2, tension: 0.3, pointBackgroundColor: '#fff', pointBorderColor: '#007755', fill: true
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { x: {grid: {display:false}, ticks: {maxTicksLimit: 10}}, y: {beginAtZero: true, grid: {color: '#f0f0f0'}} } }
        });
    } else if (ctx) {
        ctx.style.display = 'none';
        ctx.parentElement.innerHTML += '<p style="text-align:center; color:#999; padding-top:100px;">Keine Daten.</p>';
    }
});

function openTab(tabId) {
    document.querySelectorAll('.dashboard-panel').forEach(p => p.style.display = 'none');
    document.getElementById(tabId).style.display = 'block';
    document.querySelectorAll('.dashboard-tab-btn').forEach(b => b.classList.remove('active'));
    const btns = document.querySelectorAll('.dashboard-tab-btn');
    btns.forEach(b => { if(b.getAttribute('onclick').includes(tabId)) b.classList.add('active'); });
    localStorage.setItem("activeDashboardTab", tabId);
}

function openMediaSubTab(tabId) {
    document.querySelectorAll('.media-subpanel').forEach(p => p.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelectorAll('.media-subtab-btn').forEach(b => b.classList.remove('active'));
    const btns = document.querySelectorAll('.media-subtab-btn');
    btns.forEach(b => { if(b.getAttribute('onclick').includes(tabId)) b.classList.add('active'); });
    localStorage.setItem("activeMediaTab", tabId);
}

function openJobSubTab(id) {
    document.querySelectorAll('.job-subpanel').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');

    const btns = document.querySelectorAll('#karriere .media-subtab-btn');
    btns.forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');

    // Save Button nur bei Content zeigen
    const saveBtn = document.getElementById('save-jobs-btn');
    if (id === 'job-content') saveBtn.style.display = 'block';
    else saveBtn.style.display = 'none';
}

function toggleReply(id) {
    const row = document.getElementById(`reply-row-${id}`);
    row.style.display = (row.style.display === "none") ? "table-row" : "none";
}

function saveAllMedia() {
    // Logik: Finde aktives Panel (egal ob Media oder Karriere)
    let activePanel = document.querySelector('.dashboard-panel[style*="block"]');
    if (!activePanel) return;

    // Falls Medien oder Karriere, suche aktives Subpanel
    const activeSub = activePanel.querySelector('.media-subpanel.active, .job-subpanel.active');
    const container = activeSub ? activeSub : activePanel;

    const forms = container.querySelectorAll('.media-upload-form');
    let changedForms = [];

    forms.forEach(form => {
        const inputs = form.querySelectorAll('input, textarea');
        let isChanged = false;
        inputs.forEach(input => {
            if (input.type === 'file') { if (input.files.length > 0) isChanged = true; }
            else if (input.type !== 'hidden' && input.type !== 'submit') {
                const original = input.getAttribute('data-original');
                if (original !== null && input.value !== original) isChanged = true;
            }
        });
        if (isChanged) changedForms.push(form);
    });

    if (changedForms.length === 0) { showToast("Keine √Ñnderungen.", "info"); return; }

    // Sucht den Save Button im Header oder im Container
    const btn = document.querySelector('.media-header .btn-primary') || container.querySelector('.btn-primary');
    const originalText = btn ? btn.innerText : "";
    if(btn) { btn.innerText = "Speichere..."; btn.disabled = true; }

    const promises = changedForms.map(form => {
        const formData = new FormData(form);
        return fetch(form.action, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest' } }).then(r => r.ok);
    });

    Promise.all(promises).then(() => {
        if(btn) { btn.innerText = originalText; btn.disabled = false; }
        showToast("Gespeichert!");
        setTimeout(() => location.reload(), 1000);
    });
}

function markProcessed(appId) {
    fetch(`/dashboard/application/${appId}/processed/`).then(() => {
        const span = document.getElementById(`status-text-${appId}`);
        span.innerText = "Bearbeitet"; span.style.color = "#27ae60";
        span.closest('tr').style.backgroundColor = "transparent";
    });
}

function showToast(msg, type="success") {
    const toast = document.getElementById("toast");
    toast.innerText = msg;
    toast.className = "toast show";
    toast.style.backgroundColor = (type === "info") ? "#333" : "var(--kbg-green)";
    setTimeout(() => toast.className = toast.className.replace("show", ""), 3000);
}

function openModal(src) {
    const m = document.getElementById("imageModal");
    document.getElementById("modalImg").src = src;
    m.style.display = "flex";
}
function closeModal() { document.getElementById("imageModal").style.display = "none"; }
</script>

<style>
    :root { --kbg-green: #007755; --kbg-green-hover: #005a41; }
    .btn-primary { background-color: var(--kbg-green) !important; border-color: var(--kbg-green) !important; color: #fff; }
    .btn-primary:hover { background-color: var(--kbg-green-hover) !important; }

    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #eee; }
    .header-actions { display: flex; gap: 1rem; }
    .dashboard-tabs { display: flex; gap: 5px; margin-bottom: 1.5rem; border-bottom: 2px solid #eee; }
    .dashboard-tab-btn { background: transparent; border: none; padding: 10px 20px; font-size: 1rem; cursor: pointer; color: #666; border-bottom: 2px solid transparent; transition: 0.2s; }
    .dashboard-tab-btn.active { color: var(--kbg-green); border-bottom: 2px solid var(--kbg-green); font-weight: bold; }
    .dashboard-panel { display: none; animation: fadeIn 0.3s ease; }

    .media-subtabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .media-subtab-btn { background: #eee; border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; color: #555; }
    .media-subtab-btn.active { background: var(--kbg-green); color: #fff; }
    .media-subpanel, .job-subpanel { display: none; }
    .media-subpanel.active, .job-subpanel.active { display: block; }

    .media-row-container { display: grid; grid-template-columns: 80px 2fr 1.5fr 1.5fr; gap: 1.5rem; align-items: center; background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 1rem; border: 1px solid #f0f0f0; }
    .media-thumb { order: -1; } .media-info { order: 1; } .media-alt { order: 2; } .media-file { order: 3; }
    .media-thumb img { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid #eee; transition: 0.2s; }
    .media-thumb img:hover { transform: scale(1.1); }

    /* Statistiken Grid Fix */
    .stats-grid-top { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
    .stats-grid-bottom { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    .stat-card { display: flex; align-items: center; gap: 1.5rem; }

    .table-responsive { background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; }
    .modern-table { width: 100%; border-collapse: collapse; }
    .modern-table th { background: #f8f9fa; text-align: left; padding: 12px 15px; border-bottom: 1px solid #eee; color: #555; }
    .modern-table td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
    .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .badge-open { background: #fff3cd; color: #856404; } .badge-done { background: #d4edda; color: #155724; }
    .badge-admin { background: #cce5ff; color: #004085; } .badge-user { background: #e2e3e5; color: #383d41; }

    .reply-box { padding: 1rem; border-left: 3px solid var(--kbg-green); margin: 1rem; background: #fff; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .user-layout { display: flex; gap: 2rem; flex-wrap: wrap; }
    .user-list { flex: 2; min-width: 300px; } .user-create { flex: 1; min-width: 280px; }
    .form-control { width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.9rem; margin-top: 4px; box-sizing: border-box; }

    /* Utility */
    .shadow-sm { box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; background: #fff; border-radius: 8px; }
    .card { background: #fff; border-radius: 8px; }

    .image-modal { display: none; position: fixed; z-index: 1000; inset: 0; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
    .modal-content { max-width: 90%; max-height: 90vh; }
    .close-modal { position: absolute; top: 20px; right: 40px; color: #fff; font-size: 50px; cursor: pointer; }
    .toast { visibility: hidden; min-width: 250px; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 999; left: 50%; bottom: 30px; transform: translateX(-50%); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    @media (max-width: 1100px) { .media-row-container { grid-template-columns: 1fr; text-align: center; gap: 1rem; } .media-thumb { margin: 0 auto; } }
    @media (max-width: 900px) { .user-layout { flex-direction: column; } .stats-grid-top, .stats-grid-bottom { grid-template-columns: 1fr; } }
</style>
{% endblock %}