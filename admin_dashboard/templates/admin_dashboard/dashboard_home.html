{% extends "base.html" %}
{% load static %}
{% load media_tags %}

{% block title %}Dashboard | KBG Europe{% endblock %}

{% block content %}
<!-- Chart.js Bibliothek laden -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Modal f√ºr Bildvorschau -->
<div id="imageModal" class="image-modal" onclick="closeModal()">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImg">
    <div id="caption"></div>
</div>

<section class="section section-light" style="min-height: 80vh;">
    <div class="container">

        <!-- HEADER -->
        <div class="dashboard-header">
            <div>
                <h1 class="section-title" style="margin-bottom: 0;">Dashboard</h1>
                <p style="color: #666;">Willkommen im internen Bereich.</p>
            </div>
            <div class="header-actions">
                <a class="btn" href="{% url 'home' %}" style="background: #fff; border: 1px solid #ddd; color: #333;">Zur√ºck zur Website</a>
                <form method="post" action="{% url 'logout' %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary">Abmelden</button>
                </form>
            </div>
        </div>

        <!-- LAYOUT -->
        <div class="dashboard-layout">

            <!-- TABS -->
            <nav class="dashboard-tabs" aria-label="Dashboard-Bereiche">
                <button type="button" class="dashboard-tab-btn" onclick="openTab('statistiken')">Statistiken</button>
                <button type="button" class="dashboard-tab-btn" onclick="openTab('anfragen')">Anfragen</button>
                <button type="button" class="dashboard-tab-btn" onclick="openTab('medien')">Medien</button>
                <button type="button" class="dashboard-tab-btn" onclick="openTab('seo')">SEO</button>
                {% if user.is_superuser %}
                <button type="button" class="dashboard-tab-btn" onclick="openTab('benutzer')">Benutzer-Management</button>
                {% endif %}
            </nav>

            <!-- PANELS -->
            <div class="dashboard-panels">

                <!-- 1. STATISTIKEN -->
                <div id="statistiken" class="dashboard-panel">
                    <div class="stats-header mb-4">
                        <h2>Website Performance</h2>
                        <p style="color:#777; font-size:0.9rem;">Daten der letzten 30 Tage (Live-Berechnung)</p>
                    </div>

                    <!-- A) Key Metrics Cards -->
                    <div class="stats-grid-top">
                        <div class="stat-card">
                            <div class="stat-icon" style="background:#e0f2f1; color:#007755;">üë•</div>
                            <div class="stat-info">
                                <h3>{{ stats.total_visits|default:"0" }}</h3>
                                <p>Seitenaufrufe</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background:#e8f5e9; color:#2e7d32;">üñ±Ô∏è</div>
                            <div class="stat-info">
                                <h3>{{ stats.unique_visitors|default:"0" }}</h3>
                                <p>Eindeutige Besucher</p>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon" style="background:#fff3e0; color:#f57c00;">üìÖ</div>
                            <div class="stat-info">
                                <h3>{{ stats.today_visits|default:"0" }}</h3>
                                <p>Aufrufe heute</p>
                            </div>
                        </div>
                    </div>

                    <!-- B) DIAGRAMM -->
                    <div class="card p-4 mt-4 mb-4">
                        <h4 style="margin-bottom: 1rem;">Besucher-Trend (30 Tage)</h4>
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="trafficChart"></canvas>
                        </div>
                    </div>

                    <!-- C) Top Pages Tabelle -->
                    <div class="card p-4">
                        <h4>Beliebteste Seiten</h4>
                        <table class="simple-table mt-3">
                            <thead>
                                <tr>
                                    <th>Seite (Pfad)</th>
                                    <th>Aufrufe</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% if stats.top_pages %}
                                    {% for page in stats.top_pages %}
                                    <tr>
                                        <td>{{ page.path }}</td>
                                        <td><strong>{{ page.count }}</strong></td>
                                    </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr><td colspan="2">Noch keine Daten verf√ºgbar.</td></tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 2. ANFRAGEN -->
                <div id="anfragen" class="dashboard-panel">
                    <h2>Anfragen Verwaltung</h2>

                    <!-- Catering Tabelle -->
                    <div class="table-section">
                        <h3>Catering-Anfragen</h3>
                        <div class="table-responsive">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>Datum</th>
                                        <th>Name</th>
                                        <th>E-Mail</th>
                                        <th>Status</th>
                                        <th style="text-align: right;">Aktion</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for req in catering_requests %}
                                    <tr>
                                        <td>{{ req.created_at|date:"d.m.Y" }}<br><small style="color:#888;">{{ req.created_at|date:"H:i" }} Uhr</small></td>
                                        <td><strong>{{ req.contact_person }}</strong></td>
                                        <td><a href="mailto:{{ req.email }}">{{ req.email }}</a></td>
                                        <td>
                                            {% if req.status == "open" %}
                                                <span class="badge badge-open">Offen</span>
                                            {% else %}
                                                <span class="badge badge-done">Beantwortet</span>
                                            {% endif %}
                                        </td>
                                        <td style="text-align: right;">
                                            <button type="button" class="btn-icon" onclick="toggleReply('catering-{{ req.id }}')">
                                                ‚Ü© Antworten
                                            </button>
                                        </td>
                                    </tr>
                                    <tr id="reply-row-catering-{{ req.id }}" class="reply-row" style="display:none;">
                                        <td colspan="5">
                                            <div class="reply-box">
                                                <form method="post" action="{% url 'answer_catering_request' req.id %}">
                                                    {% csrf_token %}
                                                    <label>Antwort an {{ req.email }}:</label>
                                                    <textarea name="reply_text" class="form-control reply-textarea">{% if req.reply_text %}{{ req.reply_text }}{% endif %}</textarea>
                                                    <div style="margin-top:.5rem; text-align: right;">
                                                        <button type="submit" class="btn btn-primary btn-sm">Senden & Abschlie√üen</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="5" style="text-align:center; padding: 2rem;">Keine Catering-Anfragen vorhanden.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Kontakt Tabelle -->
                    <div class="table-section mt-5">
                        <h3>Kontakt-Anfragen</h3>
                        <div class="table-responsive">
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>Datum</th>
                                        <th>Name</th>
                                        <th>Betreff / Nachricht</th>
                                        <th>Status</th>
                                        <th style="text-align: right;">Aktion</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for req in contact_requests %}
                                    <tr>
                                        <!-- Datum MIT Uhrzeit -->
                                        <td>{{ req.created_at|date:"d.m.Y" }}<br><small style="color:#888;">{{ req.created_at|date:"H:i" }} Uhr</small></td>
                                        <td>{{ req.name }}<br><small>{{ req.email }}</small></td>
                                        <td><div style="max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ req.message }}</div></td>
                                        <td>
                                            {% if req.status == "open" %}
                                                <span class="badge badge-open">Offen</span>
                                            {% else %}
                                                <span class="badge badge-done">Beantwortet</span>
                                            {% endif %}
                                        </td>
                                        <td style="text-align: right;">
                                            <button type="button" class="btn-icon" onclick="toggleReply('contact-{{ req.id }}')">
                                                ‚Ü© Antworten
                                            </button>
                                        </td>
                                    </tr>
                                    <tr id="reply-row-contact-{{ req.id }}" class="reply-row" style="display:none;">
                                        <td colspan="5">
                                            <div class="reply-box">
                                                <form method="post" action="{% url 'answer_contact_request' req.id %}">
                                                    {% csrf_token %}
                                                    <label>Antwort an {{ req.email }}:</label>
                                                    <textarea name="reply_text" class="form-control reply-textarea">{% if req.reply_text %}{{ req.reply_text }}{% endif %}</textarea>
                                                    <div style="margin-top:.5rem; text-align: right;">
                                                        <button type="submit" class="btn btn-primary btn-sm">Senden & Abschlie√üen</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr><td colspan="5" style="text-align:center; padding: 2rem;">Keine Kontakt-Anfragen vorhanden.</td></tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 3. MEDIEN -->
                <div id="medien" class="dashboard-panel">
                    <div class="media-header">
                        <h2>Medien Verwaltung</h2>
                        <button type="button" class="btn btn-primary" onclick="saveAllMedia()">
                            üíæ Alle √Ñnderungen speichern
                        </button>
                    </div>

                    <nav class="media-subtabs">
                        <button type="button" class="media-subtab-btn active" onclick="openMediaSubTab('media-home')">Home</button>
                        <button type="button" class="media-subtab-btn" onclick="openMediaSubTab('media-menu')">Men√º</button>
                        <button type="button" class="media-subtab-btn" onclick="openMediaSubTab('media-catering')">Catering</button>
                        <button type="button" class="media-subtab-btn" onclick="openMediaSubTab('media-kontakt')">Kontakt</button>
                        <button type="button" class="media-subtab-btn" onclick="openMediaSubTab('media-layout')">Layout / Logo</button>
                    </nav>

                    <!-- HOME TAB -->
                    <div id="media-home" class="media-subpanel active">
                        <h3>Startseite</h3>
                        {% include "admin_dashboard/includes/media_row.html" with key="home_hero" label="Hero Bild" desc="Gro√ües Bild ganz oben." img_obj=site_images.home_hero %}
                        {% include "admin_dashboard/includes/media_row.html" with key="home_about_image" label="Wer wir sind (Slider 1)" desc="Slider Bild 1." img_obj=site_images.home_about_image %}
                        {% include "admin_dashboard/includes/media_row.html" with key="home_about_image_2" label="Wer wir sind (Slider 2)" desc="Slider Bild 2." img_obj=site_images.home_about_image_2 %}
                        {% include "admin_dashboard/includes/media_row.html" with key="home_menu_1" label="Men√º Links" desc="Bild links (25%)." img_obj=site_images.home_menu_1 %}
                        {% include "admin_dashboard/includes/media_row.html" with key="home_menu_2" label="Men√º Rechts" desc="Bild rechts (25%)." img_obj=site_images.home_menu_2 %}
                        <h4 class="mt-4">Catering Galerie</h4>
                        {% include "admin_dashboard/includes/media_row.html" with key="home_catering_1" label="Catering 1" desc="Spalte 1" img_obj=site_images.home_catering_1 %}
                        {% include "admin_dashboard/includes/media_row.html" with key="home_catering_2" label="Catering 2" desc="Spalte 2" img_obj=site_images.home_catering_2 %}
                        {% include "admin_dashboard/includes/media_row.html" with key="home_catering_3" label="Catering 3" desc="Spalte 3" img_obj=site_images.home_catering_3 %}
                        {% include "admin_dashboard/includes/media_row.html" with key="home_catering_4" label="Catering 4" desc="Spalte 4" img_obj=site_images.home_catering_4 %}
                        <h4 class="mt-4">Kundenstimmen</h4>
                        {% include "admin_dashboard/includes/media_row.html" with key="home_testimonials_bg" label="Hintergrund" desc="Hinter dem Slider." img_obj=site_images.home_testimonials_bg %}
                    </div>

                    <!-- MENU TAB -->
                    <div id="media-menu" class="media-subpanel">
                        <h3>Men√º Seite</h3>
                        {% include "admin_dashboard/includes/media_row.html" with key="menu_hero" label="Menu Hero" desc="Header Bild." img_obj=site_images.menu_hero %}
                    </div>

                    <!-- CATERING TAB -->
                    <div id="media-catering" class="media-subpanel">
                        <h3>Catering Seite</h3>
                        {% include "admin_dashboard/includes/media_row.html" with key="catering_hero" label="Catering Hero" desc="Bild oben." img_obj=site_images.catering_hero %}
                        {% include "admin_dashboard/includes/media_row.html" with key="catering_bottom" label="Catering Unten" desc="Dekobild unten." img_obj=site_images.catering_bottom %}
                    </div>

                    <!-- KONTAKT TAB -->
                    <div id="media-kontakt" class="media-subpanel">
                        <h3>Kontakt Seite</h3>
                        {% include "admin_dashboard/includes/media_row.html" with key="contact_top_bg" label="Kontakt Header" desc="Hintergrundbild oben." img_obj=site_images.contact_top_bg %}
                    </div>

                    <!-- LAYOUT TAB -->
                    <div id="media-layout" class="media-subpanel">
                        <h3>Layout & Logos</h3>
                        {% include "admin_dashboard/includes/media_row.html" with key="global_logo" label="Logo Header" desc="Hauptlogo." img_obj=site_images.global_logo %}
                        {% include "admin_dashboard/includes/media_row.html" with key="instagram_icon" label="Instagram Icon" desc="F√ºr Footer & Tabs." img_obj=site_images.instagram_icon %}
                        {% include "admin_dashboard/includes/media_row.html" with key="email_icon" label="Email Icon" desc="F√ºr Footer & Tabs." img_obj=site_images.email_icon %}
                    </div>
                </div>

                <!-- 4. SEO -->
                <div id="seo" class="dashboard-panel">
                    <h2>SEO Einstellungen</h2>
                    <form method="post" action="">
                        {% csrf_token %}
                        <div class="form-group mb-3">
                            <label>Meta-Titel</label>
                            <input type="text" name="meta_title" class="form-control" placeholder="Titel der Website...">
                        </div>
                        <div class="form-group mb-3">
                            <label>Meta-Beschreibung</label>
                            <textarea name="meta_description" class="form-control" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Speichern</button>
                    </form>
                </div>

                <!-- 5. BENUTZER MANAGEMENT -->
                {% if user.is_superuser %}
                <div id="benutzer" class="dashboard-panel">
                    <h2>Benutzer Management</h2>

                    <div class="user-layout">
                        <!-- Linke Seite: Tabelle (2/3) -->
                        <div class="user-list">
                            <h3>Registrierte Benutzer</h3>
                            <table class="modern-table">
                                <thead>
                                    <tr>
                                        <th>Benutzername</th>
                                        <th>E-Mail</th>
                                        <th>Rolle</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for u in users %}
                                    <tr>
                                        <td>{{ u.username }}</td>
                                        <td>{{ u.email }}</td>
                                        <td>
                                            {% if u.is_superuser %}
                                                <span class="badge badge-admin">Admin</span>
                                            {% else %}
                                                <span class="badge badge-user">User</span>
                                            {% endif %}
                                        </td>
                                        <td style="text-align:right;">
                                            {% if u != user %}
                                                <form method="post" action="{% url 'dashboard_delete_user' u.id %}" onsubmit="return confirm('Wirklich l√∂schen?');">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn-icon delete big-delete" title="Benutzer l√∂schen">
                                                        üóë
                                                    </button>
                                                </form>
                                            {% else %}
                                                <span style="font-size:0.8rem; color:#aaa;">(Du)</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Rechte Seite: Erstellen (1/3) -->
                        <div class="user-create">
                            <div class="card p-4">
                                <h3>Neuen Benutzer anlegen</h3>
                                <p style="font-size:0.85rem; color:#666;">Passwort wird automatisch generiert und per E-Mail gesendet.</p>

                                <form method="post" action="{% url 'dashboard_create_user' %}">
                                    {% csrf_token %}
                                    <div class="form-group mb-3">
                                        <label>Benutzername</label>
                                        <input type="text" name="new_username" class="form-control" required>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label>E-Mail</label>
                                        <input type="email" name="new_email" class="form-control" required>
                                    </div>
                                    <div class="form-group mb-4">
                                        <label>Rolle</label>
                                        <select name="new_role" class="form-control">
                                            <option value="common">Standard User</option>
                                            <option value="admin">Administrator</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-primary" style="width:100%;">Benutzer erstellen</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

            </div>
        </div>

    </div>
</section>

<!-- TOAST NOTIFICATION -->
<div id="toast" class="toast">Einstellungen gespeichert!</div>

<script>
// --- 1. TABS LOGIK & PERSISTENZ ---
document.addEventListener("DOMContentLoaded", function() {
    const lastTab = localStorage.getItem("activeDashboardTab") || "statistiken";
    openTab(lastTab);

    const lastMediaTab = localStorage.getItem("activeMediaTab") || "media-home";
    openMediaSubTab(lastMediaTab);

    // --- CHART.JS INITIALISIERUNG (CRASH PROOF) ---
    const ctx = document.getElementById('trafficChart');

    // Wir holen die Daten "safe" mit Default-Werten, falls das Backend noch nicht soweit ist.
    // Falls 'stats' nicht existiert, wird ein leeres Array genutzt.
    const chartLabels = {{ stats.chart_labels|default:"[]"|safe }};
    const chartData = {{ stats.chart_data|default:"[]"|safe }};

    if(ctx && chartLabels.length > 0) {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'Seitenaufrufe',
                    data: chartData,
                    borderColor: '#007755',
                    backgroundColor: 'rgba(0, 119, 85, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#007755',
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: '#fff',
                        titleColor: '#333',
                        bodyColor: '#333',
                        borderColor: '#eee',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: { maxTicksLimit: 10, color: '#888' }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: '#f0f0f0' },
                        ticks: { color: '#888' }
                    }
                }
            }
        });
    } else if (ctx) {
        // Fallback Meldung im Canvas Container
        ctx.style.display = 'none';
        const container = ctx.parentElement;
        const msg = document.createElement('div');
        msg.innerHTML = '<p style="text-align:center; color:#999; padding-top:100px;">Keine Statistik-Daten verf√ºgbar.<br><small>Bitte views.py und middleware.py aktualisieren.</small></p>';
        container.appendChild(msg);
    }
});

function openTab(tabId) {
    document.querySelectorAll('.dashboard-panel').forEach(p => p.style.display = 'none');
    document.getElementById(tabId).style.display = 'block';

    document.querySelectorAll('.dashboard-tab-btn').forEach(b => b.classList.remove('active'));
    const btns = document.querySelectorAll('.dashboard-tab-btn');
    btns.forEach(btn => {
        if(btn.getAttribute('onclick').includes(tabId)) btn.classList.add('active');
    });

    localStorage.setItem("activeDashboardTab", tabId);
}

function openMediaSubTab(tabId) {
    document.querySelectorAll('.media-subpanel').forEach(p => p.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');

    document.querySelectorAll('.media-subtab-btn').forEach(b => b.classList.remove('active'));
    const btns = document.querySelectorAll('.media-subtab-btn');
    btns.forEach(btn => {
        if(btn.getAttribute('onclick').includes(tabId)) btn.classList.add('active');
    });

    localStorage.setItem("activeMediaTab", tabId);
}

// --- 2. ANFRAGEN REPLY TOGGLE ---
function toggleReply(id) {
    const row = document.getElementById(`reply-row-${id}`);
    if (row.style.display === "none") row.style.display = "table-row";
    else row.style.display = "none";
}

// --- 3. AJAX SAVE FOR MEDIA ---
function saveAllMedia() {
    const activeSubTab = document.querySelector('.media-subpanel.active');
    if(!activeSubTab) return;

    const forms = activeSubTab.querySelectorAll('.media-upload-form');
    let changedForms = [];

    forms.forEach(form => {
        const fileInput = form.querySelector('input[type="file"]');
        const altInput = form.querySelector('input[name="alt_text"]');
        const originalAlt = altInput.getAttribute('data-original');

        if (fileInput.files.length > 0 || altInput.value !== originalAlt) {
            changedForms.push(form);
        }
    });

    if (changedForms.length === 0) {
        showToast("Keine √Ñnderungen erkannt.", "info");
        return;
    }

    const btn = document.querySelector('.media-header .btn');
    const originalText = btn.innerText;
    btn.innerText = "Speichere...";
    btn.disabled = true;

    const promises = changedForms.map(form => {
        const formData = new FormData(form);
        return fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        }).then(response => {
            if(response.ok) {
                const altInput = form.querySelector('input[name="alt_text"]');
                altInput.setAttribute('data-original', altInput.value);
                form.querySelector('input[type="file"]').value = "";
                return true;
            }
            return false;
        });
    });

    Promise.all(promises).then(results => {
        btn.innerText = originalText;
        btn.disabled = false;
        showToast("Erfolgreich gespeichert!");
        setTimeout(() => location.reload(), 1000);
    });
}

function showToast(msg, type="success") {
    const toast = document.getElementById("toast");
    toast.innerText = msg;
    toast.className = "toast show";
    if(type === "info") toast.style.backgroundColor = "#333";
    setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
}

// --- 4. MODAL VORSCHAU ---
function openModal(src, title) {
    if(!src || src === "") return;
    const modal = document.getElementById("imageModal");
    const modalImg = document.getElementById("modalImg");
    const captionText = document.getElementById("caption");

    modal.style.display = "flex";
    modalImg.src = src;
    captionText.innerHTML = title || "";
}

function closeModal() {
    document.getElementById("imageModal").style.display = "none";
}
</script>

<style>
    /* === GLOBAL COLORS & VARS === */
    :root {
        --kbg-green: #007755;
        --kbg-green-hover: #005a41;
        --kbg-green-light: #e0f2f1;
    }

    .btn-primary { background-color: var(--kbg-green) !important; border-color: var(--kbg-green) !important; color: #fff; }
    .btn-primary:hover { background-color: var(--kbg-green-hover) !important; }

    /* === GLOBAL DASHBOARD === */
    .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #eee; }
    .header-actions { display: flex; gap: 1rem; }

    /* === TABS === */
    .dashboard-tabs { display: flex; gap: 5px; margin-bottom: 1.5rem; border-bottom: 2px solid #eee; }
    .dashboard-tab-btn { background: transparent; border: none; padding: 10px 20px; font-size: 1rem; cursor: pointer; color: #666; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
    .dashboard-tab-btn:hover { color: var(--kbg-green); background: #f9f9f9; }
    .dashboard-tab-btn.active { color: var(--kbg-green); border-bottom: 2px solid var(--kbg-green); font-weight: bold; }
    .dashboard-panel { display: none; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* === STATISTICS CUSTOM UI === */
    .stats-grid-top { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
    .stat-card { background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); display: flex; align-items: center; gap: 1rem; }
    .stat-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0; }
    .stat-info h3 { margin: 0; font-size: 1.6rem; color: #333; }
    .stat-info p { margin: 0; color: #777; font-size: 0.85rem; }

    .stats-grid-bottom { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
    .simple-table { width: 100%; border-collapse: collapse; }
    .simple-table th { text-align: left; border-bottom: 1px solid #eee; padding: 8px 0; color: #555; font-size: 0.9rem; }
    .simple-table td { border-bottom: 1px solid #f9f9f9; padding: 8px 0; font-size: 0.95rem; color: #333; }

    /* === MEDIA SUBTABS === */
    .media-subtabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .media-subtab-btn { background: #eee; border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; color: #555; }
    .media-subtab-btn.active { background: var(--kbg-green); color: #fff; }
    .media-subpanel { display: none; }
    .media-subpanel.active { display: block; }

    /* === MEDIA ROW LAYOUT (GRID - FIXED) === */
    .media-row-container {
        display: grid;
        grid-template-columns: 80px 2fr 1.5fr 1.5fr;
        gap: 1.5rem;
        align-items: center;
        background: #fff;
        padding: 1rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        margin-bottom: 1rem;
        border: 1px solid #f0f0f0;
    }

    /* Order manipulation */
    .media-thumb { order: -1; }
    .media-info { order: 1; }
    .media-alt { order: 2; }
    .media-file { order: 3; }

    .media-info h5 { margin: 0 0 0.25rem 0; font-size: 1rem; font-weight: 600; }
    .media-info p { margin: 0; font-size: 0.85rem; color: #777; }
    .media-filename { font-family: monospace; color: #555; font-size: 0.8rem; background: #f5f5f5; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }

    .media-thumb img { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid #eee; transition: transform 0.2s; }
    .media-thumb img:hover { transform: scale(1.1); border-color: var(--kbg-green); }

    /* === TABLES (Modern) === */
    .table-section h3 { font-size: 1.2rem; color: #444; margin-bottom: 1rem; }
    .table-responsive { background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; }
    .modern-table { width: 100%; border-collapse: collapse; }
    .modern-table th { background: #f8f9fa; text-align: left; padding: 12px 15px; font-weight: 600; color: #555; border-bottom: 1px solid #eee; }
    .modern-table td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
    .modern-table tr:last-child td { border-bottom: none; }

    .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .badge-open { background: #fff3cd; color: #856404; }
    .badge-done { background: #d4edda; color: #155724; }
    .badge-admin { background: #cce5ff; color: #004085; }
    .badge-user { background: #e2e3e5; color: #383d41; }

    .btn-icon { background: none; border: none; cursor: pointer; font-size: 0.9rem; color: var(--kbg-green); transition: color 0.2s; }
    .btn-icon:hover { text-decoration: underline; color: var(--kbg-green-hover); }

    /* Bigger Delete Button */
    .btn-icon.delete.big-delete { color: #d32f2f; background: #ffebee; padding: 6px 10px; border-radius: 4px; font-size: 1.1rem; transition: background 0.2s; }
    .btn-icon.delete.big-delete:hover { background: #ffcdd2; }

    /* Fix f√ºr Reply Textarea Overflow */
    .reply-row { background: #fafafa; }
    .reply-box { padding: 1rem; border-left: 3px solid var(--kbg-green); margin: 0 1rem 1rem 1rem; background: #fff; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); width: calc(100% - 2rem); box-sizing: border-box; }
    .reply-textarea { width: 100%; box-sizing: border-box; resize: vertical; }

    /* === USER SPLIT LAYOUT === */
    .user-layout { display: flex; gap: 2rem; flex-wrap: wrap; }
    .user-list { flex: 2; min-width: 300px; }
    .user-create { flex: 1; min-width: 280px; }

    /* === MODAL & TOAST === */
    .image-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
    .modal-content { margin: auto; display: block; max-width: 90%; max-height: 90vh; object-fit: contain; border-radius: 4px; }
    .close-modal { position: absolute; top: 20px; right: 40px; color: #fff; font-size: 50px; font-weight: bold; cursor: pointer; z-index: 1001; }

    .toast { visibility: hidden; min-width: 250px; background-color: var(--kbg-green); color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 999; left: 50%; bottom: 30px; transform: translateX(-50%); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

    /* === FORM ELEMENTS === */
    .form-control { width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; margin-top: 4px; box-sizing: border-box; }
    input[type="file"] { font-size: 0.85rem; }
    .media-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }

    @media (max-width: 1100px) {
        .media-row-container { grid-template-columns: 1fr; gap: 1rem; text-align: center; }
        .media-thumb { order: -1; margin: 0 auto; }
        .media-info { order: 0; }
        .media-alt { order: 1; }
        .media-file { order: 2; }
    }
    @media (max-width: 900px) {
        .user-layout { flex-direction: column; }
    }
</style>

{% endblock %}